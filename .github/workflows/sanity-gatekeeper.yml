name: Sanity Gatekeeper - Hybrid CI + ADK Agent

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  sanity-check:
    runs-on: macos-14

    # Explicit permissions for GITHUB_TOKEN
    permissions:
      contents: read        # Read repository contents
      pull-requests: write  # Post comments on PRs
      issues: write         # Write to issues (PRs are issues)
      checks: read          # Read check run status

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer

      # Step 1: Run SwiftLint (Continue on error)
      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        continue-on-error: true
        run: |
          swiftlint lint --reporter json > swiftlint_result.json || true
          echo "SwiftLint completed (errors ignored)"

      - name: Upload SwiftLint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: swiftlint-results
          path: swiftlint_result.json

      # Step 2: Run xcodebuild test for iPad Pro (11-inch) (Continue on error)
      - name: Build and Test on iPad Pro (11-inch)
        continue-on-error: true
        run: |
          set -o pipefail
          xcodebuild test \
            -project SignLanguageModel.xcodeproj \
            -scheme SignLanguageModel \
            -destination 'platform=iOS Simulator,name=iPad Pro (11-inch) (4th generation),OS=17.2' \
            -derivedDataPath DerivedData \
            -enableCodeCoverage YES \
            | tee xcodebuild.log || true
          echo "xcodebuild test completed (errors ignored)"

      - name: Upload Build Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs
          path: xcodebuild.log

      - name: Collect Snapshot Test Results
        if: always()
        run: |
          # Find all snapshot diff images
          find . -name "*.diff.png" -type f > snapshot_diffs.txt || true
          find . -name "*.failure.png" -type f >> snapshot_diffs.txt || true
          find . -name "*.reference.png" -type f >> snapshot_diffs.txt || true

          # Create snapshots directory
          mkdir -p snapshots_artifacts

          # Copy all snapshot images to artifacts directory
          if [ -s snapshot_diffs.txt ]; then
            while IFS= read -r file; do
              cp "$file" snapshots_artifacts/ || true
            done < snapshot_diffs.txt
            echo "Snapshot images collected"
          else
            echo "No snapshot images found"
          fi

      - name: Upload Snapshot Images
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snapshot-images
          path: snapshots_artifacts/
          if-no-files-found: ignore

      # Step 3: Setup Python & Google ADK
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r agents/requirements.txt

      # Step 4: Run the ADK Sanity Agent
      - name: Run Sanity Inspector Agent
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}
        run: |
          python agents/sanity_agent.py

      - name: Upload Agent Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: agent-report
          path: agent_report.json
          if-no-files-found: ignore
